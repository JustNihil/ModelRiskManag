<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление рисками IT-проектов</title>
    <link rel="stylesheet" href="styles.css" id="css-link">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Управление рисками IT-проектов</h1>

    <!-- Добавление этапов -->
    <div class="section">
        <h2>Этапы проекта</h2>
        <div class="input-row">
            <div class="input-group">
                <label for="stageName">Название этапа</label>
                <input type="text" id="stageName" placeholder="Название">
            </div>
            <div class="input-group">
                <label for="stageDuration">Продолжительность (дни)</label>
                <input type="number" id="stageDuration" placeholder="Продолжительность">
            </div>
            <div class="input-group">
                <label for="stageCost">Стоимость ($)</label>
                <input type="number" id="stageCost" placeholder="Стоимость">
            </div>
            <div class="input-group">
                <label for="stageDependencies">Зависимости (имена этапов через запятую)</label>
                <input type="text" id="stageDependencies" placeholder="Этап1, Этап2">
            </div>
            <button onclick="window.addStage()">Добавить этап</button>
        </div>
        <table id="stagesTable">
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Продолжительность (дни)</th>
                    <th>Стоимость ($)</th>
                    <th>Зависимости</th>
                    <th>Фактическая длительность (дни)</th>
                    <th>Фактическая стоимость ($)</th>
                    <th>Удалить</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Обновление прогресса -->
    <div class="section">
        <h2>Обновление прогресса</h2>
        <div id="progressUpdateForm"></div>
        <button onclick="window.updateProgress()">Обновить прогресс</button>
    </div>

    <!-- Добавление рисков -->
    <div class="section">
        <h2>Риски</h2>
        <div class="input-row">
            <div class="input-group">
                <label for="riskName">Название риска</label>
                <input type="text" id="riskName" placeholder="Название">
            </div>
            <div class="input-group">
                <label for="riskProb">Вероятность (0-1)</label>
                <input type="number" id="riskProb" step="0.1" min="0" max="1" placeholder="Вероятность">
            </div>
            <div class="input-group">
                <label for="riskTime">Влияние на время (дни)</label>
                <input type="number" id="riskTime" min="0" placeholder="Влияние на время">
            </div>
            <div class="input-group">
                <label for="riskCost">Влияние на стоимость ($)</label>
                <input type="number" id="riskCost" min="0" placeholder="Влияние на стоимость">
            </div>
            <div class="input-group">
                <label for="riskStrategy">Стратегия</label>
                <select id="riskStrategy">
                    <option value="Ignore">Игнорировать</option>
                    <option value="Mitigate">Снизить</option>
                    <option value="Eliminate">Устранить</option>
                </select>
            </div>
            <div class="input-group">
                <label for="riskCategory">Категория</label>
                <select id="riskCategory">
                    <option value="Технические">Технические</option>
                    <option value="Организационные">Организационные</option>
                    <option value="Внешние">Внешние</option>
                    <option value="Не указано">Не указано</option>
                </select>
            </div>
            <button onclick="window.addCustomRisk()">Добавить риск</button>
        </div>
        <div class="input-row">
            <div class="input-group">
                <label for="typicalRiskCategory">Типичные риски</label>
                <select id="typicalRiskCategory">
                    <option value="">Выберите категорию</option>
                    <option value="Технические">Технические</option>
                    <option value="Организационные">Организационные</option>
                    <option value="Внешние">Внешние</option>
                </select>
            </div>
            <button onclick="window.addTypicalRisksByCategory(document.getElementById('typicalRiskCategory').value)">Добавить риски категории</button>
        </div>
        <table id="risksTable">
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Вероятность</th>
                    <th>Время (дни)</th>
                    <th>Стоимость ($)</th>
                    <th>Стратегия</th>
                    <th>Категория</th>
                    <th>Удалить</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Настройки модели -->
    <div class="section">
        <h2>Настройки модели</h2>
        <div class="input-row">
            <div class="input-group">
                <label for="timeThreshold">Пороговое время (дни):</label>
                <input type="number" id="timeThreshold" value="150">
            </div>
            <div class="input-group">
                <label for="costThreshold">Пороговая стоимость ($):</label>
                <input type="number" id="costThreshold" value="75000">
            </div>
            <div class="input-group">
                <label for="targetTime">Целевое время (дни):</label>
                <input type="number" id="targetTime" value="120">
            </div>
            <div class="input-group">
                <label for="targetCost">Целевая стоимость ($):</label>
                <input type="number" id="targetCost" value="60000">
            </div>
        </div>
        <div class="action-buttons">
            <button onclick="window.createModel()">Создать модель</button>
            <!--<button onclick="window.saveData()">Сохранить данные</button>-->
            <button onclick="window.loadData()">Загрузить данные</button>
        </div>
    </div>

    <!-- Стратегия управления рисками -->
    <div class="section">
        <h2>Стратегия управления рисками</h2>
        <div class="input-row">
            <div class="input-group">
                <label for="mitigationStrategy">Стратегия:</label>
                <select id="mitigationStrategy">
                    <option value="Ignore">Игнорировать</option>
                    <option value="Mitigate">Снизить</option>
                    <option value="Eliminate">Устранить</option>
                </select>
            </div>
            <div class="input-group">
                <label for="mitigationBudget">Бюджет ($):</label>
                <input type="number" id="mitigationBudget" value="10000" placeholder="Бюджет">
            </div>
            <button onclick="window.setMitigation()">Установить</button>
            <button onclick="window.runSimulation()">Пересчитать симуляцию</button>

        </div>
    </div>

    <!-- Результаты и рекомендации -->
    <div class="section dashboard">
        <h2>Результаты и рекомендации</h2>
        <div id="dashboardSummary"></div>
        
        <div class="chart-container chart-centered">
            <h4>Стоимость проекта</h4>
            <canvas id="metricsChart" width="600" height="200"></canvas>
        </div>

        <div class="chart-row">
            <div class="chart-container">
                <h4>Влияние рисков на стоимость</h4>
                <canvas id="costImpactChart" width="500" height="300"></canvas>
            </div>
            <div class="chart-container">
                <h4>Влияние рисков на время</h4>
                <canvas id="timeImpactChart" width="500" height="300"></canvas>
            </div>
        </div>
        
        <div class="chart-row">
            <div class="chart-container">
                <h4>Распределение стоимости</h4>
                <canvas id="costDistributionChart" width="500" height="300"></canvas>
            </div>
            <div class="chart-container">
                <h4>Распределение времени</h4>
                <canvas id="timeDistributionChart" width="500" height="300"></canvas>
            </div>
        </div>
        
        <table id="riskResultsTable">
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Снижен</th>
                    <th>Время (дни)</th>
                    <th>Стоимость ($)</th>
                    <th>Стратегия</th>
                    <th>Категория</th>
                    <th>Приоритет</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="recommendations"></div>
        <div id="riskLogs">
            <h3>Логи рисков</h3>
            <table id="riskLogsTable">
                <thead>
                    <tr>
                        <th>Риск</th>
                        <th>Действие</th>
                        <th>Детали</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { stages, addStage, removeStage, updateStagesTable } from './stages.js';
        import { updateProgress, fetchRiskLogs } from './api.js';
        import { updateRiskLogsTable } from './dashboard.js';

        // Динамическое создание формы для обновления прогресса
        function updateProgressForm() {
            console.log("Вызов updateProgressForm, stages:", stages);
            const formDiv = document.getElementById('progressUpdateForm');
            if (!formDiv) {
                console.error("Элемент с ID 'progressUpdateForm' не найден");
                return;
            }
            formDiv.innerHTML = '';
            stages.forEach(stage => {
                if (!stage.safeName) {
                    console.error(`safeName не определён для этапа ${stage.name}, создаём его`);
                    stage.safeName = stage.name.replace(/[^a-zA-Z0-9-_]/g, '_');
                }
                console.log(`Создание полей для этапа ${stage.name}, safeName: ${stage.safeName}`);
                const stageDiv = document.createElement('div');
                stageDiv.className = 'input-row';
                stageDiv.innerHTML = `
                    <div class="input-group">
                        <label>Этап: ${stage.name}</label>
                    </div>
                    <div class="input-group">
                        <label for="actualDuration_${stage.safeName}">Фактическая длительность (дни):</label>
                        <input type="number" id="actualDuration_${stage.safeName}" value="${stage.actualDuration || 0}" min="0">
                    </div>
                    <div class="input-group">
                        <label for="actualCost_${stage.safeName}">Фактическая стоимость ($):</label>
                        <input type="number" id="actualCost_${stage.safeName}" value="${stage.actualCost || 0}" min="0">
                    </div>
                `;
                formDiv.appendChild(stageDiv);
            });
        }

        // Переопределяем updateStagesTable для вызова updateProgressForm
        const originalUpdateStagesTable = updateStagesTable;
        window.updateStagesTable = function() {
            originalUpdateStagesTable();
            updateProgressForm();
        };

        // Инициализация формы и логов при загрузке
        document.addEventListener('DOMContentLoaded', async () => {
            updateProgressForm();
            const logs = await fetchRiskLogs();
            updateRiskLogsTable(logs);
        });
    </script>

    <script type="module" src="api.js"></script>
    <script type="module" src="dashboard.js"></script>
    <script type="module" src="stages.js"></script>
    <script type="module" src="risks.js"></script>
    <script type="module" src="simulation.js"></script>
    <script type="module" src="storage.js"></script>
    <script type="module" src="main.js"></script>
</body>
</html>